// è·¯ç”±é‰´æƒ --- é‰´æƒï¼š é¡¹ç›®ä¸­è·¯ç”±èƒ½ä¸èƒ½è¢«è®¿é—®æƒé™çš„è®¾ç½®ï¼ˆè¯¥è·¯ç”±å¯ä»¥åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹è¢«è®¿é—®ã€ä»€ä¹ˆæ¡ä»¶ä¸‹ä¸å¯è®¿é—®ï¼‰
// å¯¼å…¥è·¯ç”±ç»„ä»¶ã€storeå·¥å…·å‡½æ•°
import router from '@/router/index'
import { userStoreFn } from '@/utils/_store'
import { getUserInfoService, logoutService } from '@/services/userService'
import { ElMessage } from 'element-plus'

// è·¯ç”±å…¨å±€å‰ç½®å®ˆå« ---
router.beforeEach(async (to) => {
  /*
    1ã€å½“ç”¨æˆ·ç™»å½•å¹¶åœ¨æœ¬åœ°å­˜å‚¨tokenåŽï¼Œä»Žä¸€ä¸ªè·¯ç”±è·³åˆ°å¦ä¸€ä¸ªè·¯ç”±æ—¶ï¼Œç”¨æˆ·ä¿¡æ¯å› ä¸ºæ˜¯å®žæ—¶èŽ·å–çš„ï¼Œå¯èƒ½å­˜åœ¨userInfoæ²¡æœ‰è¯·æ±‚åˆ°ï¼Œä½†æ˜¯é¡µé¢å°±æ¸²æŸ“çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿æ•°æ®å…ˆè¯·æ±‚åˆ° -> å†è¿›è¡Œé¡µé¢æ¸²æŸ“
    2ã€å½“ç”¨æˆ·ç™»å½•ï¼Œä½†æ˜¯æœ¬åœ°tokenå…¶å®žæ˜¯â€œç”¨æˆ·â€ðŸ˜ä¼ªé€ çš„ï¼Œæˆ–è€…tokenè¿‡æœŸäº†ï¼Œé‚£ä¹ˆä¹‹åŽæ•°æ®è¯·æ±‚æ“ä½œåŸºæœ¬ä¸Šéƒ½ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ä»¥ä¸‹åˆ¤æ–­ä¹Ÿä¼šèµ·åˆ°åŒé‡éªŒè¯ä¸Žé¢„è­¦åŠŸèƒ½ã€‚
  */
  if (userStoreFn().token) {
    // æœ‰Tokenï¼Œè¯æ˜Žä½ å·²ç»ç™»å½•ï¼Œæ­¤æ—¶ä½ å†æƒ³åŽ»ç™»å½•é¡µ --- æ‹¦æˆªè·³è½¬åˆ°é¦–é¡µ
    if (to.path === '/login') {
      return '/'
    } else {
      // ä¸åŽ»é¦–é¡µï¼Œæ­£å¸¸æµè§ˆè®¿é—® --- ä½†æ˜¯å¾—ç­‰æ•°æ®è¯·æ±‚å®Œæ¯•ï¼ŒèŽ·å¾—æ•°æ®åŽæ‰èƒ½è¿›è¡Œè·¯ç”±è·³è½¬
      if (userStoreFn().userInfo.name) {
        // æ­¤æ—¶æœ‰Tokenï¼Œæœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œä½†å¦‚æžœåˆ·æ–°äº†
        return true
      } else {
        // æ²¡æœ‰æ­£å¸¸èŽ·å–æ•°æ® --- è¯´æ˜Žå¯èƒ½æ˜¯ç”¨æˆ·åˆ·æ–° ã€é¦–æ¬¡ç™»å½• ã€ç”¨æˆ·ä¼ªé€ Tokenï¼ˆtokenæ˜¯å‡æ•°æ®ï¼‰
        try {
          await getUserInfoService(router)
          /*
           *ä¸Šé¢ä¸‰ç§æƒ…å†µåˆšå¥½ä¹Ÿæ˜¯è·¯ç”±è¡¨éœ€è¦é‡è½½æ³¨å†Œçš„æ—¶å€™ï¼Œæ‰€ä»¥æ­¤æ—¶èŽ·å–è·¯ç”±ä¿¡æ¯è¿›è¡Œé‡è½½æ³¨å†Œ
           *èŽ·å–è·¯ç”±ä¿¡æ¯å¹¶è¿›è¡Œæ³¨å†Œæˆ‘å°†å…¶æ”¾å…¥ getUserInfoService(router)å‡½æ•°ä¸­ï¼Œä¸ŽèŽ·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ä¸€èµ·å®žçŽ°äº†
           *ä¸‹é¢ä»£ç ä½œç”¨ï¼š...to ä¿ç•™äº†ç›®æ ‡è·¯ç”±çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆpathã€queryã€paramsç­‰ï¼‰
           *replace: true è¡¨ç¤ºæ›¿æ¢å½“å‰åŽ†å²è®°å½•ï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°è®°å½•
           *è¿™æ ·è¿”å›žä¼šè§¦å‘ä¸€æ¬¡æ–°çš„å¯¼èˆªï¼Œç¡®ä¿åœ¨åŠ¨æ€è·¯ç”±æ³¨å†Œå®ŒæˆåŽå†æ¬¡å°è¯•è®¿é—®ç›®æ ‡è·¯ç”±
           */
          return { ...to, replace: true }
        } catch (error) {
          // å‡ºçŽ°é”™è¯¯ --- è¯´æ˜Žæœ¬åœ°tokenç»è¿‡æ›´æ”¹æˆ–è€…å…¶ä»–ä¸çŸ¥åé”™è¯¯ï¼Œæ¸…ç©ºæ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œé‡æ–°ç™»é™†
          ElMessage.warning(error)
          // è¿›è¡Œæ•°æ®åˆ é™¤æ“ä½œ --- ä»Žä»“åº“ä¸­åˆ é™¤tokenã€userInfo
          await logoutService()
          return '/login'
        }
      }
    }
  } else {
    // æ²¡æœ‰Tokenï¼Œä½†æ­¤æ—¶è¦è·³è½¬ç™»å½•é¡µï¼Œè¯´æ˜Žç”¨æˆ·è¦ç™»å½•ï¼Œå…è®¸ç”¨æˆ·ç™»å½•
    if (to.path === '/login') {
      return
    } else {
      // å½“æ²¡æœ‰æ£€æµ‹åˆ°ç”¨æˆ·Token å¹¶ä¸” ç”¨æˆ·æ­¤æ—¶ä¹Ÿä¸è¦åŽ»ç™»å½•é¡µæ—¶ --- æ‹¦æˆªåˆ°ç™»å½•é¡µ
      return '/login'
    }
  }
})

// è·¯ç”±å…¨å±€åŽç½®å®ˆå« ---
router.afterEach(() => {})
